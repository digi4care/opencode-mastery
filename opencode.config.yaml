# OpenCode Configuration
# Single source of truth for all features, plugins, and settings.
# 
# Documentation: docs/project/config-system.md
# 
# How it works:
# 1. All plugins/tools load this config via src/lib/config
# 2. Changes here affect all components immediately
# 3. Missing fields use defaults from src/lib/config/defaults.ts

version: "1.0"

project:
  name: opencode-mastery
  description: OpenCode documentation and tooling
  version: "1.0.0"

features:
  # Memory - Persistent project memory
  memory:
    enabled: true
    lazyLoading: true
    compaction:
      enabled: true
      max_size_kb: 50
      keep_entries: 10
    types:
      episodic:
        enabled: false
        retention: 30d
      semantic:
        enabled: false
        scope: project

    # Embeddings - Vector embedding configuration
    embeddings:
      provider: auto        # auto | local | openai | gemini | voyage
      model: null           # Specific model override (null = use default for provider)
      batchSize: 100        # Embeddings per batch

    # Search - Memory retrieval configuration
    search:
      hybrid:
        enabled: true       # Combine vector + text search
        vectorWeight: 0.7   # Weight for vector similarity (0-1)
        textWeight: 0.3     # Weight for text matching (0-1)
        candidateMultiplier: 4  # Candidates before reranking
      minScore: 0.35        # Minimum relevance score (0-1)
      maxResults: 10        # Maximum results returned

    # Chunking - Content splitting configuration
    chunking:
      tokens: 400           # Target tokens per chunk
      overlap: 80           # Token overlap between chunks

    # Storage - Persistence configuration
    storage:
      vector:
        enabled: true       # Enable vector storage
      cache:
        enabled: true       # Enable result caching
        maxEntries: 10000   # Maximum cache entries

    # Intent - Intent detection configuration
    intent:
      enabled: true         # Enable intent classification
      languages: [en, nl, de, fr, es]  # Supported languages
      confidenceThreshold: 0.7  # Minimum confidence to accept

    # Snapshots - Conversation context configuration
    snapshots:
      enabled: true         # Enable context snapshots
      maxMessages: 15       # Messages per snapshot
      maxContentLength: 500 # Characters per message

  # Docs - OpenCode documentation access
  docs:
    enabled: true
    context7: true           # Use Context7 API for live docs
    local_fallback: true     # Fall back to local cache when offline
    cache_ttl_days: 7        # Refresh local cache after X days
    auto_download: false     # Auto-download on first use

  # TDD - Test-Driven Development enforcement
  tdd:
    enabled: true
    enforce_on_write: true   # Check when writing files
    block_without_test: true # Prevent writes without test
    verify_red_phase: true   # Require seeing test fail
    check_git_order: false   # Verify test committed first

  # Debugging - Systematic debugging assistant
  debugging:
    enabled: true
    auto_start_on_error: true    # Auto-start debug workflow
    max_fix_attempts: 3          # Max tries before questioning architecture
    track_phases: true           # Track 4-phase progress
    require_test_before_fix: true # Require failing test first

  # Playwright - Browser automation
  playwright:
    enabled: true
    headless: false          # Show browser window
    screenshots: true        # Take screenshots on errors
    video: false             # Record video
    trace: false             # Record trace
    default_timeout: 30000   # Default timeout in ms

  # Session - OpenCode session management and ACE analysis
  # Uses SDK client - works with ANY port, no server config needed!
  session:
    enabled: true
    track:
      tool_calls: true       # Track tool invocations
      ai_responses: false    # Track AI responses (can be large)
      subagent_calls: true   # Track subagent invocations
      file_changes: true     # Track file modifications
    storage:
      max_sessions: 100      # Maximum sessions to keep
      retention_days: 30     # Days before cleanup
    ace:
      max_subagent_depth: 2  # Max nesting for analysis subagents
      auto_apply_suggestions: false  # Auto-apply ACE suggestions
      auto_analyze_on_end: false     # Auto-analyze when session ends

  # Flow Analyzer - Framework-agnostic flow analysis
  flowAnalyzer:
    enabled: true
    register_agents: true       # Register flow-analyzer and gsd-flow-analyzer agents
    strict_default: false       # Default strictness for analysis runs
    max_gaps_reported: 50       # Prevent overly large reports
    agent_tool_mode: scoped     # scoped | all
    framework_defaults:
      gsd: true                 # Enable GSD-specific adapter defaults
      generic: true             # Enable generic adapter defaults

  # GSD Validation Runtime - Automated validation orchestration tools
  gsdValidation:
    enabled: true
    default_mode: full          # quick | full
    require_gap_gate: true      # enforce human gate when gaps are found
    readiness_timeout_ms: 30000 # default server readiness timeout

  # Repo Analyzer - GitHub repository analysis
  repoAnalyzer:
    enabled: true
    default_depth: 1            # Git clone depth (1 = shallow)
    auto_cleanup: true          # Remove cloned repo after analysis
    tmp_dir: ""                 # Override temp directory (empty = use system default)

  # Skill Creator - Create and improve OpenCode skills
  skillCreator:
    enabled: true
    strict_validation: true     # Enforce quality gates
    allow_dry_run: true        # Allow dry-run without changes
